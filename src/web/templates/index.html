<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор бассейна</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pool-preview {
            width: 100%;
            height: 300px;
            border: 2px solid #ccc;
            margin: 20px 0;
            position: relative;
        }
        .stair-fields {
            max-height: 300px;
            overflow-y: auto;
        }
        .material-row:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Калькулятор бассейна</h1>
        
        <div class="row">
            <!-- Форма параметров -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Параметры бассейна</h5>
                    </div>
                    <div class="card-body">
                        <form id="poolForm">
                            <!-- Форма бассейна -->
                            <div class="mb-3">
                                <label class="form-label">Форма бассейна</label>
                                <select class="form-select" id="shape" name="shape">
                                    <option value="Прямоугольный">Прямоугольный</option>
                                    <option value="Овальный">Овальный</option>
                                    <option value="L-образный">L-образный</option>
                                </select>
                            </div>
                            
                            <!-- Основные размеры -->
                            <div class="mb-3">
                                <label class="form-label">Длина (мм)</label>
                                <input type="number" class="form-control" id="length" name="length" min="2000" value="8000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ширина (мм)</label>
                                <input type="number" class="form-control" id="width" name="width" min="1500" value="4000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Глубина (мм)</label>
                                <input type="number" class="form-control" id="depth" name="depth" min="600" max="2500" value="1500">
                            </div>
                            
                            <!-- L-образные размеры -->
                            <div id="l-shape-fields" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Длина выступа (мм)</label>
                                    <input type="number" class="form-control" id="l_length" name="l_length" min="1000" value="3000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ширина выступа (мм)</label>
                                    <input type="number" class="form-control" id="l_width" name="l_width" min="1000" value="2000">
                                </div>
                            </div>
                            
                            <!-- Тип отделки -->
                            <div class="mb-3">
                                <label class="form-label">Тип отделки</label>
                                <select class="form-select" id="finish_type" name="finish_type">
                                    <option value="Плитка">Керамогранит/Мозаика</option>
                                    <option value="Лайнер">Лайнер ПВХ</option>
                                </select>
                            </div>
                            
                            <!-- Ступени -->
                            <div class="mb-3">
                                <label class="form-label">Количество ступеней</label>
                                <input type="number" class="form-control" id="stair_count" min="0" max="6" value="0">
                            </div>
                            <div id="stair-fields" class="stair-fields">
                                <!-- Поля ступеней будут добавлены динамически -->
                            </div>
                            
                            <button type="submit" class="btn btn-primary mt-3">Рассчитать</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Результаты -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Предварительный просмотр</h5>
                    </div>
                    <div class="card-body">
                        <div class="pool-preview" id="poolPreview">
                            <!-- Canvas для отрисовки бассейна -->
                            <canvas id="previewCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Материалы</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="exportPDF()">
                                <i class="bi bi-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportExcel()">
                                <i class="bi bi-file-excel"></i> Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Материал</th>
                                        <th class="text-end">Количество</th>
                                        <th>Ед. изм.</th>
                                        <th class="text-end">Цена</th>
                                        <th class="text-end">Сумма</th>
                                    </tr>
                                </thead>
                                <tbody id="materialsTable">
                                    <!-- Результаты расчета будут добавлены динамически -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-info">
                                        <td colspan="4"><strong>Итого:</strong></td>
                                        <td class="text-end" id="totalSum"><strong>0</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Обработка формы бассейна
        document.getElementById('shape').addEventListener('change', function() {
            const lShapeFields = document.getElementById('l-shape-fields');
            lShapeFields.style.display = this.value === 'L-образный' ? 'block' : 'none';
            updatePreview();
        });

        // Обработка количества ступеней
        document.getElementById('stair_count').addEventListener('change', function() {
            const count = parseInt(this.value) || 0;
            const container = document.getElementById('stair-fields');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const stairGroup = document.createElement('div');
                stairGroup.className = 'card mb-2';
                stairGroup.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">Ступень ${i + 1}</h6>
                        <div class="mb-2">
                            <label class="form-label">Ширина (мм)</label>
                            <input type="number" class="form-control stair-width" 
                                   min="200" max="1000" step="50" value="300">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Высота (мм)</label>
                            <input type="number" class="form-control stair-height"
                                   min="100" max="300" step="50" value="150">
                        </div>
                    </div>
                `;
                container.appendChild(stairGroup);
            }
            updatePreview();
        });

        // Обновление превью бассейна
        function updatePreview() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            const container = document.querySelector('.pool-preview');
            
            // Устанавливаем размер canvas равным размеру контейнера
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            // Очищаем canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Получаем параметры бассейна
            const shape = document.getElementById('shape').value;
            const length = parseInt(document.getElementById('length').value);
            const width = parseInt(document.getElementById('width').value);
            
            // Вычисляем масштаб
            const scale = Math.min(
                (canvas.width - 40) / length,
                (canvas.height - 40) / width
            );
            
            // Рисуем бассейн
            ctx.beginPath();
            ctx.strokeStyle = '#0d6efd';
            ctx.fillStyle = '#e7f1ff';
            
            const x = (canvas.width - length * scale) / 2;
            const y = (canvas.height - width * scale) / 2;
            
            if (shape === 'Прямоугольный') {
                ctx.rect(x, y, length * scale, width * scale);
            } else if (shape === 'Овальный') {
                ctx.ellipse(
                    x + (length * scale) / 2,
                    y + (width * scale) / 2,
                    (length * scale) / 2,
                    (width * scale) / 2,
                    0, 0, 2 * Math.PI
                );
            } else if (shape === 'L-образный') {
                const l_length = parseInt(document.getElementById('l_length').value);
                const l_width = parseInt(document.getElementById('l_width').value);
                
                ctx.moveTo(x, y);
                ctx.lineTo(x + length * scale, y);
                ctx.lineTo(x + length * scale, y + l_width * scale);
                ctx.lineTo(x + (length - l_length) * scale, y + l_width * scale);
                ctx.lineTo(x + (length - l_length) * scale, y + width * scale);
                ctx.lineTo(x, y + width * scale);
                ctx.closePath();
            }
            
            ctx.fill();
            ctx.stroke();
        }

        // Обработка отправки формы
        document.getElementById('poolForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Собираем данные формы
            const formData = {
                shape: document.getElementById('shape').value,
                length: parseInt(document.getElementById('length').value),
                width: parseInt(document.getElementById('width').value),
                depth: parseInt(document.getElementById('depth').value),
                finish_type: document.getElementById('finish_type').value
            };
            
            // Добавляем L-образные размеры если нужно
            if (formData.shape === 'L-образный') {
                formData.l_length = parseInt(document.getElementById('l_length').value);
                formData.l_width = parseInt(document.getElementById('l_width').value);
            }
            
            // Собираем данные о ступенях
            const stairCount = parseInt(document.getElementById('stair_count').value) || 0;
            formData.stairs = [];
            
            const widthInputs = document.querySelectorAll('.stair-width');
            const heightInputs = document.querySelectorAll('.stair-height');
            
            for (let i = 0; i < stairCount; i++) {
                formData.stairs.push({
                    width: parseInt(widthInputs[i].value),
                    height: parseInt(heightInputs[i].value)
                });
            }
            
            try {
                // Отправляем запрос на сервер
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Обновляем таблицу материалов
                    const tbody = document.getElementById('materialsTable');
                    tbody.innerHTML = '';
                    let total = 0;
                    
                    result.materials.forEach(material => {
                        const sum = material.quantity * material.price;
                        total += sum;
                        
                        tbody.innerHTML += `
                            <tr class="material-row">
                                <td>${material.name}</td>
                                <td class="text-end">${material.quantity}</td>
                                <td>${material.unit}</td>
                                <td class="text-end">${material.price.toLocaleString()} ₽</td>
                                <td class="text-end">${sum.toLocaleString()} ₽</td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('totalSum').textContent = total.toLocaleString() + ' ₽';
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка при отправке запроса: ' + error.message);
            }
        });

        // Обновляем превью при изменении размеров
        ['length', 'width', 'l_length', 'l_width'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updatePreview);
            }
        });

        // Инициализация превью
        updatePreview();

        // Функции экспорта
        async function exportPDF() {
            try {
                const response = await fetch('/api/export/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(getFormData())
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'расчет_бассейна.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    throw new Error('Ошибка при экспорте PDF');
                }
            } catch (error) {
                alert('Ошибка при экспорте в PDF: ' + error.message);
            }
        }

        async function exportExcel() {
            try {
                const response = await fetch('/api/export/excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(getFormData())
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'расчет_бассейна.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    throw new Error('Ошибка при экспорте Excel');
                }
            } catch (error) {
                alert('Ошибка при экспорте в Excel: ' + error.message);
            }
        }

        function getFormData() {
            // Получаем все данные формы
            const formData = {
                shape: document.getElementById('shape').value,
                length: parseInt(document.getElementById('length').value),
                width: parseInt(document.getElementById('width').value),
                depth: parseInt(document.getElementById('depth').value),
                finish_type: document.getElementById('finish_type').value
            };
            
            // Добавляем L-образные размеры если нужно
            if (formData.shape === 'L-образный') {
                formData.l_length = parseInt(document.getElementById('l_length').value);
                formData.l_width = parseInt(document.getElementById('l_width').value);
            }
            
            // Собираем данные о ступенях
            const stairCount = parseInt(document.getElementById('stair_count').value) || 0;
            formData.stairs = [];
            
            const widthInputs = document.querySelectorAll('.stair-width');
            const heightInputs = document.querySelectorAll('.stair-height');
            
            for (let i = 0; i < stairCount; i++) {
                formData.stairs.push({
                    width: parseInt(widthInputs[i].value),
                    height: parseInt(heightInputs[i].value)
                });
            }
            
            return formData;
        }
    </script>
</body>
</html>
